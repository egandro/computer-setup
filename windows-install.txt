rem https://tinyurl.com/wininsta
rem https://learn.microsoft.com/en-us/visualstudio/deployment/tutorial-import-publish-settings-iis?view=vs-2022#install-and-configure-web-deploy-on-windows-server

Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))

choco install -y brave

rem choco install -y firefox

choco install -y vscode

choco install -y 7zip

rem choco install -y git
rem with bash

choco install -y git.install --force --params "'/GitAndUnixToolsOnPath'"

rem choco install -y svn

choco install -y wget

choco install -y curl

choco install -y yt-dlp

choco install -y ffmpeg

choco install -y winscp

rem rsync for windows sill sucks
choco install -y rclone

choco install -y winrar

choco install -y nodejs

rem choco install -y virtualbox --params "/NoDesktopShortcut /ExtensionPack" --ignore-checksums

choco install -y s3browser

rem choco install -y python3

rem choco install windirstat /y

choco install -y kubernetes-cli

choco install -y kubernetes-helm

choco install -y freelens --ignore-checksums

choco install -y another-redis-desktop-manager 

choco install -y vlc

rem choco install -y foxitreader

choco install -y okular

choco install -y inkscape

choco install -y gimp

choco install -y drawio

choco install -y pencil

choco install -y nordvpn

rem download tigervnc from here - https://sourceforge.net/projects/tigervnc/files/stable/1.16.0/

choco install -y docker-cli

choco install -y docker-compose

choco install -y localsend

# set DOCKER_HOST=ssh://foo.abar
# store in system:
# setx DOCKER_HOST ssh://1.2.3.4

rem java
choco install -y openjdk

# choco install -y mingw

choco install -y make

choco install -y jq

# choco install -y audacity

rem choco install androidstudio
rem choco install android-sdk # this is outdated!
rem choco install arduino

rem choco install -y powertoys

choco install -y wireguard

rem visual studio
rem set VS2019_ENT_SERIAL=1.2.3.4.5.6
rem choco install -y visualstudio2022enterprise
rem "C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\Common7\IDE\StorePID.exe" %VS2019_ENT_SERIAL% 09260
rem choco install -y visualstudio2022-workload-nativedesktop
rem choco install -y visualstudio2022-workload-manageddesktop
rem choco install -y visualstudio2022-workload-netcorebuildtools

rem choco install -y cmake.install --installargs '"ADD_CMAKE_TO_PATH=System"'

rem C++ package manager
rem choco install -y conan

rem ICMP
rem https://www.howtogeek.com/howto/windows-vista/allow-pings-icmp-echo-request-through-your-windows-vista-firewall/

netsh advfirewall firewall add rule name="ICMP Allow incoming V4 echo request" protocol=icmpv4:8,any dir=in action=allow
netsh advfirewall firewall add rule name="ICMP Allow incoming V6 echo request" protocol=icmpv6:8,any dir=in action=allow

rem ssh
rem https://stackoverflow.com/questions/16212816/setting-up-openssh-for-windows-using-public-key-authentication
---
# 1. Install OpenSSH Server AND Client (Client needed for ssh-agent)
Add-WindowsCapability -Online -Name OpenSSH.Server~~~~0.0.1.0
Add-WindowsCapability -Online -Name OpenSSH.Client~~~~0.0.1.0

# 2. Set Services to start automatically
Set-Service -Name ssh-agent -StartupType Automatic
Set-Service -Name sshd -StartupType Automatic

# 3. Stop services to avoid file locks during config
Stop-Service sshd -ErrorAction SilentlyContinue
Stop-Service ssh-agent -ErrorAction SilentlyContinue

# 4. Configure sshd_config
$ConfigPath = "$Env:PROGRAMDATA\ssh\sshd_config"
$BackupPath = "$ConfigPath.bak"

# Backup if not exists
if (-not (Test-Path $BackupPath)) { Copy-Item $ConfigPath $BackupPath }

$Content = Get-Content $ConfigPath

# DISABLE ADMIN TRAP: Comment out the default Admin override block
$Content = $Content -replace 'Match Group administrators', '#Match Group administrators'
$Content = $Content -replace 'AuthorizedKeysFile __PROGRAMDATA__', '#AuthorizedKeysFile __PROGRAMDATA__'

# DEFINE SETTINGS
$Settings = @(
    "AuthorizedKeysFile .ssh/authorized_keys",
    "PasswordAuthentication no",
    "PubkeyAuthentication yes"
)

# Clean up old settings to prevent duplicates
$Content = $Content | Where-Object { 
    $_ -notmatch "PasswordAuthentication" -and 
    $_ -notmatch "PubkeyAuthentication" -and 
    $_ -notmatch "AuthorizedKeysFile" 
}

# Add new settings
$Content += $Settings

# Save with UTF8 (Encoding matches what Windows OpenSSH expects)
$Content | Set-Content $ConfigPath -Encoding UTF8

# 5. Set Default Shell (PowerShell) and Firewall
New-ItemProperty -Path "HKLM:\SOFTWARE\OpenSSH" -Name DefaultShell -Value "C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe" -PropertyType String -Force | Out-Null
New-NetFirewallRule -Name 'OpenSSH-Server-In-TCP' -DisplayName 'OpenSSH Server (sshd)' -Enabled True -Direction Inbound -Protocol TCP -Action Allow -LocalPort 22 -Force -ErrorAction SilentlyContinue | Out-Null

# 6. USER PERMISSIONS & KEYS (The Critical Fix)
$TargetUser = $env:USERNAME
$SSHDir     = "$env:USERPROFILE\.ssh"
$PubFile    = "$SSHDir\id_ed25519.pub"
$AuthFile   = "$SSHDir\authorized_keys"

# Ensure Directory Exists
if (-not (Test-Path $SSHDir)) { New-Item -ItemType Directory -Path $SSHDir -Force | Out-Null }

# Ensure authorized_keys exists with correct content and encoding (ASCII)
if (Test-Path $PubFile) {
    $KeyContent = Get-Content $PubFile -Raw
    $KeyContent | Out-File -FilePath $AuthFile -Encoding ascii -Force
}

# --- PERMISSIONS: STEP-BY-STEP ---
# A. Take ownership to Administrator group temporarily to break any OS locks
takeown /F $SSHDir /R /D Y | Out-Null

# B. Explicitly Set Owner to the ACTUAL USER (Fixes "Admin owns it" issue)
icacls $SSHDir /T /setowner "$TargetUser" | Out-Null

# C. Reset ACLs to clean slate
icacls $SSHDir /T /reset | Out-Null

# D. Disable Inheritance and Grant ONLY System + User (Fixes "Too Open" issue)
# /inheritance:r = Remove inherited permissions
# /grant = Give specific access
icacls $SSHDir /T /inheritance:r /grant "SYSTEM:F" /grant "$($TargetUser):F" | Out-Null

# 7. Start Services
Start-Service ssh-agent
Start-Service sshd
---
# ssh dir fix
# 1. Define Path and User dynamically
$SSHDir = "$env:USERPROFILE\.ssh"
$User   = $env:USERNAME

Write-Host "Fixing SSH folder: $SSHDir"
Write-Host "Target User:       $User" -ForegroundColor Cyan

if (Test-Path $SSHDir) {
    # 2. Take Ownership of everything (Breaks any 'Access Denied' locks from OS)
    # /F = File/Folder, /R = Recursive, /D Y = Confirm defaults
    takeown /F $SSHDir /R /D Y

    # 3. Nuke Permissions & Secure it
    # /T = Recursive (Apply to all keys inside)
    # /inheritance:r = Remove ALL inherited permissions (Fixes 'Too Open' error)
    # /grant ... = Add specific Full Control for YOU and SYSTEM
    icacls $SSHDir /T /inheritance:r /grant "SYSTEM:F" /grant "$($User):F"

    Write-Host "Done. Permissions fixed." -ForegroundColor Green
} else {
    Write-Error "Folder $SSHDir does not exist."
}
---
# uninstall
# 1. Stop Services
Stop-Service sshd -ErrorAction SilentlyContinue
Stop-Service ssh-agent -ErrorAction SilentlyContinue
Stop-Process -Name "sshd" -Force -ErrorAction SilentlyContinue

# 2. Uninstall OpenSSH Server
Remove-WindowsCapability -Online -Name OpenSSH.Server~~~~0.0.1.0

# 3. Delete System Configuration (sshd_config and Host Keys)
Remove-Item -Path "$Env:PROGRAMDATA\ssh" -Recurse -Force -ErrorAction SilentlyContinue

# 4. Delete OpenSSH Registry Settings (e.g., DefaultShell)
Remove-Item -Path "HKLM:\SOFTWARE\OpenSSH" -Recurse -Force -ErrorAction SilentlyContinue

# 5. Clean up Service Entries (if left behind)
sc.exe delete sshd | Out-Null
sc.exe delete ssh-agent | Out-Null
---

rem Bruno
rem npm install -g @usebruno/cli
rem choco install bruno /y

rem neofetch via scoop - https://www.makeuseof.com/how-to-install-and-use-neofetch-on-windows/

rem --
rem open port 8022 on firewall
rem netsh advfirewall firewall add rule name= "Open Port 8022" dir=in action=allow protocol=TCP localport=8022

rem sshfs
rem https://github.com/winfsp/sshfs-win
rem choco install sshfs /y
rem net use X: \\sshfs\user@server\foo\bar (relative to $HOME of user)
rem net use X: /delete

